[tox]
envlist = py39, py310, py311, lint, safety
skipsdist=True

[testenv]
setenv =
  LC_ALL=en_US.UTF-8

passenv =
  SQLALCHEMY_DATABASE_URI

allowlist_externals =
  poetry
  make
  mkdir

commands_pre =
  pip install -U pip setuptools wheel
  poetry install

commands =
  # ensure instance dir exists
  mkdir -p -v {toxinidir}/instance

  # run tests (no parallelism because it fails on CircleCI)
  poetry run pytest


[testenv:lint]
skip_install = true

commands =
  poetry run ruff src tests
  poetry run flake8 src tests
  # TODO: there are still mypy errors.
  # poetry run adt all
  # No makefile for now, TODO: fix later
  # make lint
  # make test-assets


[testenv:safety]
commands_pre =
  poetry install --no-dev -q
  pip install -U pip setuptools wheel
  pip install safety pip-audit

commands =
  poetry run adt audit


[gh-actions]
python =
  # 3.9: py39, lint, safety
  3.9: py39, lint
  3.10: py310
  3.11: py311
